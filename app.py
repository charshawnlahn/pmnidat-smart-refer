import streamlit as st
import google.generativeai as genai
from docx import Document
from docx.shared import Pt
import io
import re
import json

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Backend Config) ---
API_KEY = "AIzaSyCeLlttCAwHuTLhkqCwAxTUZ-orIMznYT8"
genai.configure(api_key=API_KEY)
model = genai.GenerativeModel('gemini-3-flash-preview')

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå Word ‡πÅ‡∏•‡∏∞‡∏ü‡∏≠‡∏ô‡∏ï‡πå 13 (High Precision) ---
def fill_pmnidat_doc(data):
    try:
        doc = Document("PMNIDAT 062 ‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠.docx")
        mapping = {f"{{{{{k.upper()}}}}}": str(v) for k, v in data.items()}
        
        def apply_style_and_replace(paragraph):
            for key, value in mapping.items():
                if key in paragraph.text:
                    paragraph.text = paragraph.text.replace(key, value)
                    # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏Ç‡∏ô‡∏≤‡∏î 13 ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                    for run in paragraph.runs:
                        run.font.size = Pt(13)

        for p in doc.paragraphs: apply_style_and_replace(p)
        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    for p in cell.paragraphs: apply_style_and_replace(p)
                            
        buffer = io.BytesIO()
        doc.save(buffer)
        return buffer.getvalue()
    except Exception: return None

# --- 3. ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Layout ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ---
st.set_page_config(page_title="PMNIDAT 062 Smart Portal", layout="wide")
st.title("üè• PMNIDAT 062 Smart Portal")
st.write("‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á (Master Version 3.8)")

st.divider()

# ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1: Step 1 (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô)
st.subheader("üü¢ Step 1: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IPD)")
s1_cols = st.columns(4)
with s1_cols[0]: s11 = st.text_area("1.1 Admission Note", height=150, help="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏≠‡∏ô")
with s1_cols[1]: s12 = st.text_area("1.2 ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢", height=150, help="‡∏£‡∏´‡∏±‡∏™ ICD-10")
with s1_cols[2]: s13 = st.text_area("1.3 Order / Meds", height=150, help="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢")
with s1_cols[3]: s14 = st.text_area("1.4 Progress Note", height=150, help="SOAP ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")

# ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2: Step 2 ‡πÅ‡∏•‡∏∞ Step 3 (‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á)
st.divider()
col_left, col_right = st.columns([1, 2])

with col_left:
    st.subheader("üîµ Step 2: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô")
    s2 = st.text_area("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 9Q, 8Q, BPRS (‡∏´‡∏ô‡πâ‡∏≤ OPD)", height=450)

with col_right:
    st.subheader("üü† Step 3: ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Registration)")
    s31 = st.text_area("3.1 ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 1 (‡∏ä‡∏∑‡πà‡∏≠, ‡∏≠‡∏≤‡∏¢‡∏∏, ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤)", height=100)
    s32 = st.text_area("3.2 ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 2 (‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)", height=100)
    s33 = st.text_area("3.3 ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (‡∏ç‡∏≤‡∏ï‡∏¥, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)", height=100)
    s34 = st.text_area("3.4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤", height=100)

# --- 4. ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (Advanced Clinical Synthesis) ---
if st.button("üöÄ ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠"):
    all_raw = f"{s11} {s12} {s13} {s14} {s2} {s31} {s32} {s33} {s34}"
    with st.spinner('Gemini 3 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏î‡∏Å‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î...'):
        prompt = f"""
        ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å @ThanHIS ‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° 062 ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
        1. ‡∏¢‡∏≤ (MEDS): ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (\\n) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        2. ‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ (DX): ‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ (\\n) ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ '‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∏‡∏î' + '‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ï‡πá‡∏°'
        3. **‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (PROGRESS)**: ‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤: 
           - ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ 1: ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ
           - ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ 2: ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)
           - ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ 3: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á/‡πÅ‡∏ú‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
        4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô: ‡∏î‡∏∂‡∏á EDU, RELATION, POST_SERVICE ‡πÅ‡∏•‡∏∞ DC_DATE ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 100%
        5. ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö: ‡∏£‡∏∞‡∏ö‡∏∏ [‡∏û‡∏¥‡∏°‡∏û‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á]

        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö: {all_raw}
        ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô: {{"name": "..", "age": "..", "hn": "..", "id": "..", "edu": "..", "career": "..", "religion": "..", "status": "..", "rights": "..", "last_dc": "..", "admit_date": "..", "visit_num": "..", "cc": "..", "contact": "..", "relation": "..", "phone": "..", "near_hosp": "..", "dc_date": "..", "los": "..", "address": "..", "q9": "..", "q8": "..", "meds": "..", "dx": "..", "progress": "..", "post_service": ".."}}
        """
        try:
            response = model.generate_content(prompt)
            json_data = json.loads(re.search(r'\{.*\}', response.text, re.DOTALL).group())
            st.success("‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
            
            # Preview ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
            st.info("üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏á Word ‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏≠‡∏ô‡∏ï‡πå 13")
            p1, p2 = st.columns(2)
            with p1:
                json_data['progress'] = st.text_area("‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå 3 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)", value=json_data.get('progress'), height=250)
            with p2:
                json_data['dx'] = st.text_area("‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ (‡∏£‡∏´‡∏±‡∏™ + ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°)", value=json_data.get('dx'), height=110)
                json_data['meds'] = st.text_area("‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏¢‡∏≤ (‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)", value=json_data.get('meds'), height=110)

            word_file = fill_pmnidat_doc(json_data)
            if word_file:
                st.download_button("üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå 062 (.docx) ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", word_file, f"Refer_{json_data['hn']}.docx")
        except Exception as e:
            st.error(f"‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {e}")