import streamlit as st
import google.generativeai as genai
from docx import Document  # <--- à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰à¸„à¸£à¸±à¸š à¸•à¸±à¸§ D à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹ƒà¸«à¸à¹ˆ
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH
import io
import re
import json

# --- 1. à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸šà¸«à¸¥à¸±à¸‡à¸šà¹‰à¸²à¸™à¹à¸¥à¸° AI (Gemini 3 Flash Preview) ---
# à¹ƒà¸Šà¹‰à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸”à¸¶à¸‡à¸„à¹ˆà¸²à¸ˆà¸²à¸ Secrets à¹à¸—à¸™
if "GEMINI_API_KEY" in st.secrets:
    API_KEY = st.secrets["GEMINI_API_KEY"]
    genai.configure(api_key=API_KEY)
else:
    st.error("âŒ à¹„à¸¡à¹ˆà¸žà¸šà¸£à¸«à¸±à¸ª GEMINI_API_KEY à¹ƒà¸™à¸£à¸°à¸šà¸š Secrets à¸‚à¸­à¸‡ Streamlit")
model = genai.GenerativeModel('gemini-3-flash-preview')

# --- 2. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸±à¸”à¸à¸²à¸£à¹„à¸Ÿà¸¥à¹Œ Word (à¸Ÿà¸­à¸™à¸•à¹Œ 13 + à¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¹€à¸„à¸²à¸°à¸šà¸£à¸£à¸—à¸±à¸”) ---
def fill_pmnidat_doc(data):
    try:
        doc = Document("PMNIDAT 062 à¹à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸·à¹ˆà¸­à¸ªà¹ˆà¸‡à¸•à¹ˆà¸­.docx")
        mapping = {f"{{{{{k.upper()}}}}}": str(v) for k, v in data.items()}
        
        def apply_style_and_replace(paragraph):
            for key, value in mapping.items():
                if key in paragraph.text:
                    # 1. à¹à¸—à¸™à¸—à¸µà¹ˆà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸”à¸´à¸¡
                    paragraph.text = paragraph.text.replace(key, value)
                    
                    # 2. à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸Šà¸´à¸”à¸‚à¸§à¸² à¹à¸¥à¸° à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£à¸¢à¸·à¸”à¸•à¸±à¸§ (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ Distributed)
                    paragraph.alignment = WD_ALIGN_PARAGRAPH.LEFT 
                    
                    # 3. à¸šà¸±à¸‡à¸„à¸±à¸šà¸Ÿà¸­à¸™à¸•à¹Œà¸‚à¸™à¸²à¸” 13 à¸•à¸²à¸¡à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¸ªà¸–à¸²à¸šà¸±à¸™à¸¯
                    for run in paragraph.runs:
                        run.font.size = Pt(13)

        for p in doc.paragraphs: apply_style_and_replace(p)
        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    for p in cell.paragraphs: apply_style_and_replace(p)
                            
        buffer = io.BytesIO()
        doc.save(buffer)
        return buffer.getvalue()
    except Exception as e:
        st.error(f"âš ï¸ à¸›à¸±à¸à¸«à¸²à¹„à¸Ÿà¸¥à¹Œà¹à¸¡à¹ˆà¹à¸šà¸š: {e}")
        return None

# --- 3. à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸«à¸™à¹‰à¸²à¸ˆà¸­ (Linear Workflow à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸«à¸¡à¸­à¸ªà¸±à¹ˆà¸‡) ---
st.set_page_config(page_title="PMNIDAT 062 Smart Portal", layout="wide")

# Sidebar: à¹à¸à¹‰à¹„à¸‚ Syntax Error à¹à¸¥à¸°à¹€à¸žà¸´à¹ˆà¸¡à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™
with st.sidebar:
    st.image("https://pmnidathis.dms.go.th/static/media/health.1bfd961f.png", width=100)
    st.header("ðŸ“– à¸„à¸¹à¹ˆà¸¡à¸·à¸­à¸ªà¸³à¸«à¸£à¸±à¸šà¸žà¸µà¹ˆà¸žà¸¢à¸²à¸šà¸²à¸¥")
    st.info("""
    **à¸§à¸´à¸˜à¸µà¸„à¸±à¸”à¸¥à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥:** 
    1. à¸„à¸¥à¸´à¸à¹€à¸¡à¸²à¸ªà¹Œà¸‹à¹‰à¸²à¸¢à¸„à¹‰à¸²à¸‡à¹„à¸§à¹‰à¸—à¸µà¹ˆà¸•à¹‰à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ 
    2. à¸¥à¸²à¸à¹€à¸¡à¸²à¸ªà¹Œà¸¥à¸‡à¸¡à¸²à¹ƒà¸«à¹‰à¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” 
    3. à¸à¸” **Ctrl+C** (à¸«à¸£à¸·à¸­ à¸„à¸¥à¸´à¹Šà¸à¸‚à¸§à¸² à¸à¸”à¹€à¸¥à¸·à¸­à¸ Copy) 
    4. à¸¡à¸²à¸—à¸µà¹ˆà¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¸™à¸µà¹‰ à¸„à¸¥à¸´à¸à¹ƒà¸™à¸Šà¹ˆà¸­à¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸§à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    5. à¹à¸¥à¹‰à¸§à¸à¸” **Ctrl+V** ((à¸«à¸£à¸·à¸­ à¸„à¸¥à¸´à¹Šà¸à¸‚à¸§à¸² à¸à¸”à¹€à¸¥à¸·à¸­à¸ Paste) à¸„à¸£à¸±à¸š
    """)
    
    st.markdown("""
    **ðŸŸ¢ STEP 1: à¸£à¸°à¸šà¸šà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢à¹ƒà¸™ (IPD)**
    1. **Admission Note:** à¸£à¸°à¸šà¸šà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢à¹ƒà¸™ â†’ à¸à¸”à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸™à¹„à¸‚à¹‰ â†’ Admission note â†’ à¸„à¸±à¸”à¸¥à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    2. **à¸à¸²à¸£à¸§à¸´à¸™à¸´à¸ˆà¸‰à¸±à¸¢:** à¹ƒà¸™à¸«à¸™à¹‰à¸²à¹€à¸”à¸´à¸¡ à¸à¸”à¹€à¸›à¸´à¸” "à¸à¸²à¸£à¸§à¸´à¸™à¸´à¸ˆà¸‰à¸±à¸¢" â†’ à¸„à¸±à¸”à¸¥à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    3. **Order/Meds:** à¸à¸”à¹€à¸¡à¸™à¸¹ "Order"â†’ à¸„à¸±à¸”à¸¥à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    4. **Progress Note:** à¸à¸”à¹€à¸¡à¸™à¸¹ "Progress note" â†’ à¸„à¸±à¸”à¸¥à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    
    **ðŸ”µ STEP 2: à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™**
    * à¸„à¸±à¸”à¸¥à¸­à¸à¸„à¸°à¹à¸™à¸™ (9Q, 8Q, BPRS) 
    * à¹‚à¸”à¸¢à¸à¸”à¹€à¸¡à¸™à¸¹ "Admission note" â†’ à¸à¸”à¸›à¸¸à¹ˆà¸¡ **à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢à¸™à¸­à¸** â†’ à¹€à¸¥à¸·à¹ˆà¸­à¸™à¸¥à¸‡à¸¥à¹ˆà¸²à¸‡à¹„à¸›à¸•à¸£à¸‡ Assessment â†’ à¸„à¸±à¸”à¸¥à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”

    
    **ðŸŸ  STEP 3: à¹€à¸§à¸Šà¸£à¸°à¹€à¸šà¸µà¸¢à¸™ (Registration)**
    * à¸£à¸°à¸šà¸šà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢à¸™à¸­à¸ â†’ à¹€à¸§à¸Šà¸£à¸°à¹€à¸šà¸µà¸¢à¸™ â†’ **à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢** â†’ à¸à¸”à¸›à¸¸à¹ˆà¸¡ à¸„à¹‰à¸™à¸«à¸² â†’ à¸à¸£à¸­à¸ HN â†’ à¸à¸”à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸™à¹„à¸‚à¹‰
    * à¸à¸”à¸«à¸™à¹‰à¸² **à¸—à¸±à¹ˆà¸§à¹„à¸› 1**	â†’  à¸„à¸±à¸”à¸¥à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    * à¸à¸”à¸«à¸™à¹‰à¸² **à¸—à¸±à¹ˆà¸§à¹„à¸› 2**	â†’  à¸à¸”à¹à¸ªà¸”à¸‡ "à¸—à¸±à¹ˆà¸§à¹„à¸› 2.2 (à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™)"	â†’ à¸„à¸±à¸”à¸¥à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    * à¸à¸”à¸«à¸™à¹‰à¸² **à¸œà¸¹à¹‰à¸•à¸´à¸”à¸•à¹ˆà¸­**	â†’ à¸„à¸±à¸”à¸¥à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    * à¸à¸”à¸«à¸™à¹‰à¸² **à¸ªà¸´à¸—à¸˜à¸´à¸à¸²à¸£à¸£à¸±à¸à¸©à¸²**	â†’ à¸„à¸±à¸”à¸¥à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    """)
    st.divider()
    st.success("ðŸ’¡ AI à¸ˆà¸°à¸›à¸£à¸°à¸¡à¸§à¸¥à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸„à¸£à¸±à¸š à¹‚à¸”à¸¢à¸«à¸¡à¸­à¸Šà¸²à¸Œà¸²à¸™ (28 à¸.à¸ž.2569)")

# à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸«à¸¥à¸±à¸
st.title("ðŸ¥ PMNIDAT Smart D/C Transfer")
st.subheader("à¸£à¸°à¸šà¸šà¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ PMNIDAT 062 à¹à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸·à¹ˆà¸­à¸ªà¹ˆà¸‡à¸•à¹ˆà¸­.docx à¹ƒà¸™à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§")

st.divider()

# à¹à¸–à¸§à¸—à¸µà¹ˆ 1: Step 1 (IPD) - 4 à¸Šà¹ˆà¸­à¸‡à¹ƒà¸™à¹à¸–à¸§à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™
st.markdown("### **ðŸŸ¢ Step 1: à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸°à¸šà¸šà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢à¹ƒà¸™ (IPD)**")
s1_cols = st.columns(4)
with s1_cols[0]: s11 = st.text_area("1.1 Admission Note", height=150, placeholder="à¸§à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸£à¸à¸£à¸±à¸šà¹à¸¥à¸°à¸­à¸²à¸à¸²à¸£...")
with s1_cols[1]: s12 = st.text_area("1.2 à¸à¸²à¸£à¸§à¸´à¸™à¸´à¸ˆà¸‰à¸±à¸¢", height=150, placeholder="à¸§à¸²à¸‡à¸£à¸«à¸±à¸ª ICD-10 à¸Šà¸·à¹ˆà¸­à¹‚à¸£à¸„...")
with s1_cols[2]: s13 = st.text_area("1.3 Order / Meds", height=150, placeholder="à¸§à¸²à¸‡à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸² à¹à¸œà¸™à¸ˆà¸³à¸«à¸™à¹ˆà¸²à¸¢...")
with s1_cols[3]: s14 = st.text_area("1.4 Progress Note", height=150, placeholder="à¸§à¸²à¸‡ SOAP ...")

# à¹à¸–à¸§à¸—à¸µà¹ˆ 2: Step 2 (Assessment) - à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸‡à¸¥à¹ˆà¸²à¸‡
st.divider()
st.markdown("### **ðŸ”µ Step 2: à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ (Assessment)**")
s2 = st.text_area("à¸„à¸±à¸”à¸¥à¸­à¸à¸„à¸°à¹à¸™à¸™ 9Q, 8Q, BPRS (à¸ˆà¸²à¸à¸«à¸™à¹‰à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢à¸™à¸­à¸)", height=150, placeholder="à¸§à¸²à¸‡à¸œà¸¥à¸„à¸°à¹à¸™à¸™à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸—à¸µà¹ˆà¸™à¸µà¹ˆ...")

# à¹à¸–à¸§à¸—à¸µà¹ˆ 3: Step 3 (Registration) - à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸‡à¸¥à¹ˆà¸²à¸‡à¹à¸•à¹ˆà¹à¸šà¹ˆà¸‡ 4 à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸¢à¹ˆà¸­à¸¢
st.divider()
st.markdown("### **ðŸŸ  Step 3: à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸§à¸Šà¸£à¸°à¹€à¸šà¸µà¸¢à¸™ (Registration)**")
s3_cols = st.columns(4)
with s3_cols[0]: s31 = st.text_area("3.1 à¸—à¸±à¹ˆà¸§à¹„à¸› 1", height=150, placeholder="à¸Šà¸·à¹ˆà¸­, à¸­à¸²à¸¢à¸¸, à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²...")
with s3_cols[1]: s32 = st.text_area("3.2 à¸—à¸±à¹ˆà¸§à¹„à¸› 2", height=150, placeholder="à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™...")
with s3_cols[2]: s33 = st.text_area("3.3 à¸œà¸¹à¹‰à¸•à¸´à¸”à¸•à¹ˆà¸­", height=150, placeholder="à¸Šà¸·à¹ˆà¸­à¸à¸²à¸•à¸´, à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸žà¸±à¸™à¸˜à¹Œ, à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£...")
with s3_cols[3]: s34 = st.text_area("3.4 à¸ªà¸´à¸—à¸˜à¸´à¸à¸²à¸£à¸£à¸±à¸à¸©à¸²", height=150, placeholder="à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸£à¸±à¸à¸©à¸² à¹à¸¥à¸° à¸£à¸ž.à¸«à¸¥à¸±à¸...")

# --- 4. à¸ªà¹ˆà¸§à¸™à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥ (Advanced Clinical Logic) ---
if st.button("ðŸš€ à¸ªà¸à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸ªà¸±à¸‡à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹ƒà¸šà¸ªà¹ˆà¸‡à¸•à¹ˆà¸­ (Master V3.10)"):
    all_raw = f"{s11} {s12} {s13} {s14} {s2} {s31} {s32} {s33} {s34}"
    with st.spinner('Gemini 3 à¸à¸³à¸¥à¸±à¸‡à¸ªà¸±à¸‡à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸­à¸²à¸à¸²à¸£à¹à¸¥à¸°à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¸¢à¸²à¹ƒà¸«à¹‰à¸ªà¸§à¸¢à¸‡à¸²à¸¡...'):
        prompt = f"""
        à¸„à¸¸à¸“à¸„à¸·à¸­à¹à¸žà¸—à¸¢à¹Œà¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸ à¸ªà¸à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ @ThanHIS à¸¥à¸‡à¹à¸šà¸šà¸Ÿà¸­à¸£à¹Œà¸¡ 062 à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸à¸Žà¹€à¸«à¸¥à¹‡à¸:
        1. à¸¢à¸² (MEDS): à¸•à¹‰à¸­à¸‡à¸¡à¸µà¹€à¸¥à¸‚à¸¥à¸³à¸”à¸±à¸š à¹à¸¥à¸°à¹€à¸„à¸²à¸°à¸šà¸£à¸£à¸—à¸±à¸”à¹à¸¢à¸à¸£à¸²à¸¢à¸à¸²à¸£ (\\n) à¸Šà¸·à¹ˆà¸­à¸¢à¸²à¸•à¹‰à¸­à¸‡ UPPERCASE à¸žà¸£à¹‰à¸­à¸¡à¸‚à¸™à¸²à¸”à¸¢à¸²à¹à¸¥à¸°à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸„à¸£à¸šà¸–à¹‰à¸§à¸™
        2. à¸§à¸´à¸™à¸´à¸ˆà¸‰à¸±à¸¢ (DX): à¹€à¸„à¸²à¸°à¸šà¸£à¸£à¸—à¸±à¸”à¹à¸¢à¸à¹à¸•à¹ˆà¸¥à¸°à¹‚à¸£à¸„ (\\n) à¸£à¸«à¸±à¸ª ICD-10 à¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸ˆà¸¸à¸” + à¸Šà¸·à¹ˆà¸­à¹‚à¸£à¸„à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¸‰à¸šà¸±à¸šà¹€à¸•à¹‡à¸¡
        3. à¸ªà¸£à¸¸à¸›à¸›à¸±à¸à¸«à¸² (PROGRESS): à¸ªà¸±à¸‡à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸›à¹‡à¸™ 3 à¸¢à¹ˆà¸­à¸«à¸™à¹‰à¸²: 
           (1) à¸ªà¸£à¸¸à¸›à¸­à¸²à¸à¸²à¸£à¹à¸£à¸à¸£à¸±à¸š (2) à¸à¸²à¸£à¸žà¸±à¸’à¸™à¸²à¸à¸²à¸£à¸—à¸²à¸‡à¸„à¸¥à¸´à¸™à¸´à¸ (3) à¸ªà¸–à¸²à¸™à¸°à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡ à¹à¸¥à¸°à¹à¸œà¸™à¸•à¸´à¸”à¸•à¸²à¸¡
        4. à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸²à¸”à¸«à¸²à¸¢: à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸¸ [à¸žà¸´à¸¡à¸žà¹Œà¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡] à¸«à¹‰à¸²à¸¡à¹€à¸§à¹‰à¸™à¸§à¹ˆà¸²à¸‡
        5. à¸‚à¸¢à¸°à¸£à¸°à¸šà¸š: Ignore à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Theme Customizer à¹à¸¥à¸° COPYRIGHT à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”

        à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: {all_raw}
        à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™: {{"name": "..", "age": "..", "hn": "..", "id": "..", "edu": "..", "career": "..", "religion": "..", "status": "..", "rights": "..", "last_dc": "..", "admit_date": "..", "visit_num": "..", "cc": "..", "contact": "..", "relation": "..", "phone": "..", "near_hosp": "..", "dc_date": "..", "los": "..", "address": "..", "q9": "..", "q8": "..", "meds": "..", "dx": "..", "progress": "..", "post_service": ".."}}
        """
        try:
            response = model.generate_content(prompt)
            json_data = json.loads(re.search(r'\{.*\}', response.text, re.DOTALL).group())
            st.success("âœ… à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!")
            
            # Preview à¸ªà¹ˆà¸§à¸™à¸ªà¸³à¸„à¸±à¸à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸žà¸µà¹ˆà¸žà¸¢à¸²à¸šà¸²à¸¥à¸•à¸£à¸§à¸ˆà¸—à¸²à¸™
            st.subheader("ðŸ” à¸•à¸£à¸§à¸ˆà¸—à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸„à¸±à¸")
            p1, p2 = st.columns(2)
            with p1:
                json_data['progress'] = st.text_area("à¸ªà¸£à¸¸à¸›à¸›à¸±à¸à¸«à¸² (3 à¸ªà¹ˆà¸§à¸™)", value=json_data.get('progress'), height=250)
            with p2:
                json_data['meds'] = st.text_area("à¸¢à¸²à¹à¸¥à¸°à¸à¸²à¸£à¸šà¸£à¸´à¸«à¸²à¸£à¸¢à¸² (à¹€à¸„à¸²à¸°à¸šà¸£à¸£à¸—à¸±à¸”)", value=json_data.get('meds'), height=110)
                json_data['dx'] = st.text_area("à¸à¸²à¸£à¸§à¸´à¸™à¸´à¸ˆà¸‰à¸±à¸¢ (à¸£à¸«à¸±à¸ª + à¸Šà¸·à¹ˆà¸­à¹€à¸•à¹‡à¸¡)", value=json_data.get('dx'), height=110)

            word_file = fill_pmnidat_doc(json_data)
            if word_file:
                st.download_button("ðŸ’¾ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹à¸šà¸šà¸Ÿà¸­à¸£à¹Œà¸¡ 062 (à¸Ÿà¸­à¸™à¸•à¹Œ 13) à¸‰à¸šà¸±à¸šà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ", word_file, f"Refer_{json_data.get('hn','062')}.docx")
        except Exception as e:
            st.error(f"à¸£à¸°à¸šà¸šà¸‚à¸±à¸”à¸‚à¹‰à¸­à¸‡: {e}")









