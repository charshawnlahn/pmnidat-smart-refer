import streamlit as st
import google.generativeai as genai
from docx import Document
from docx.shared import Pt
import io
import re
import json

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ AI (Gemini 3 Flash Preview) ---
API_KEY = "AIzaSyCeLlttCAwHuTLhkqCwAxTUZ-orIMznYT8"
genai.configure(api_key=API_KEY)
model = genai.GenerativeModel('gemini-3-flash-preview')

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå Word (‡∏ü‡∏≠‡∏ô‡∏ï‡πå 13 + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) ---
def fill_pmnidat_doc(data):
    try:
        doc = Document("PMNIDAT 062 ‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠.docx")
        mapping = {f"{{{{{k.upper()}}}}}": str(v) for k, v in data.items()}
        
        def apply_style_and_replace(paragraph):
            for key, value in mapping.items():
                if key in paragraph.text:
                    # ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö \n ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
                    paragraph.text = paragraph.text.replace(key, value)
                    # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏Ç‡∏ô‡∏≤‡∏î 13 ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏Ø
                    for run in paragraph.runs:
                        run.font.size = Pt(13)

        for p in doc.paragraphs: apply_style_and_replace(p)
        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    for p in cell.paragraphs: apply_style_and_replace(p)
                            
        buffer = io.BytesIO()
        doc.save(buffer)
        return buffer.getvalue()
    except Exception as e:
        st.error(f"‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö: {e}")
        return None

# --- 3. ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Linear Workflow ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏™‡∏±‡πà‡∏á) ---
st.set_page_config(page_title="PMNIDAT 062 Smart Portal", layout="wide")

# Sidebar: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Syntax Error ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
with st.sidebar:
    st.image("https://pmnidathis.dms.go.th/static/media/health.1bfd961f.png", width=100)
    st.header("üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•")
    st.info("""
    **‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** 1. ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ã‡πâ‡∏≤‡∏¢‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 
    2. ‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏•‡∏á‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 
    3. ‡∏Å‡∏î **Ctrl+C** (Copy) 
    4. ‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î **Ctrl+V** (Paste) ‡∏Ñ‡πà‡∏∞
    """)
    
    st.markdown("""
    **üü¢ STEP 1: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IPD)**
    1. **Admission Note:** ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö
    2. **‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢:** ‡∏´‡∏ô‡πâ‡∏≤ ICD-10
    3. **Order/Meds:** Discharge order
    4. **Progress Note:** SOAP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    
    **üîµ STEP 2: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô**
    * ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô **Assessment** (9Q, 8Q, BPRS)
    
    **üü† STEP 3: ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Registration)**
    * ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤ '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 1', '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 2.2', '‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' ‡πÅ‡∏•‡∏∞ '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏±‡∏Å‡∏©‡∏≤'
    """)
    st.divider()
    st.success("üí° AI ‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏à‡∏∏‡∏î ICD-10 ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡πà‡∏∞")

# ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å
st.title("üè• PMNIDAT 062 Smart Portal")
st.subheader("‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (D/C Referral System)")

st.divider()

# ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1: Step 1 (IPD) - 4 ‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
st.markdown("### **üü¢ Step 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IPD)**")
s1_cols = st.columns(4)
with s1_cols[0]: s11 = st.text_area("1.1 Admission Note", height=150, placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏≠‡∏ô...")
with s1_cols[1]: s12 = st.text_area("1.2 ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢", height=150, placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ ICD-10...")
with s1_cols[2]: s13 = st.text_area("1.3 Order / Meds", height=150, placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢...")
with s1_cols[3]: s14 = st.text_area("1.4 Progress Note", height=150, placeholder="‡∏ß‡∏≤‡∏á SOAP ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...")

# ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2: Step 2 (Assessment) - ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á
st.divider()
st.markdown("### **üîµ Step 2: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (Assessment)**")
s2 = st.text_area("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 9Q, 8Q, BPRS (‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å)", height=150, placeholder="‡∏ß‡∏≤‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...")

# ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 3: Step 3 (Registration) - ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ö‡πà‡∏á 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏¢‡πà‡∏≠‡∏¢
st.divider()
st.markdown("### **üü† Step 3: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Registration)**")
s3_cols = st.columns(4)
with s3_cols[0]: s31 = st.text_area("3.1 ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 1", height=150, placeholder="‡∏ä‡∏∑‡πà‡∏≠, ‡∏≠‡∏≤‡∏¢‡∏∏, ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤...")
with s3_cols[1]: s32 = st.text_area("3.2 ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 2", height=150, placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô...")
with s3_cols[2]: s33 = st.text_area("3.3 ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", height=150, placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ç‡∏≤‡∏ï‡∏¥, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£...")
with s3_cols[3]: s34 = st.text_area("3.4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤", height=150, placeholder="‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏£‡∏û.‡∏´‡∏•‡∏±‡∏Å...")

# --- 4. ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (Advanced Clinical Logic) ---
if st.button("üöÄ ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ (Master V3.10)"):
    all_raw = f"{s11} {s12} {s13} {s14} {s2} {s31} {s32} {s33} {s34}"
    with st.spinner('Gemini 3 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°...'):
        prompt = f"""
        ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å @ThanHIS ‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° 062 ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
        1. ‡∏¢‡∏≤ (MEDS): ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (\\n) ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ï‡πâ‡∏≠‡∏á UPPERCASE ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
        2. ‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ (DX): ‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ (\\n) ‡∏£‡∏´‡∏±‡∏™ ICD-10 ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∏‡∏î + ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°
        3. ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (PROGRESS): ‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤: 
           (1) ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö (2) ‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å (3) ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
        4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢: ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏ [‡∏û‡∏¥‡∏°‡∏û‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á] ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á
        5. ‡∏Ç‡∏¢‡∏∞‡∏£‡∏∞‡∏ö‡∏ö: Ignore ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Theme Customizer ‡πÅ‡∏•‡∏∞ COPYRIGHT ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {all_raw}
        ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô: {{"name": "..", "age": "..", "hn": "..", "id": "..", "edu": "..", "career": "..", "religion": "..", "status": "..", "rights": "..", "last_dc": "..", "admit_date": "..", "visit_num": "..", "cc": "..", "contact": "..", "relation": "..", "phone": "..", "near_hosp": "..", "dc_date": "..", "los": "..", "address": "..", "q9": "..", "q8": "..", "meds": "..", "dx": "..", "progress": "..", "post_service": ".."}}
        """
        try:
            response = model.generate_content(prompt)
            json_data = json.loads(re.search(r'\{.*\}', response.text, re.DOTALL).group())
            st.success("‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
            
            # Preview ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô
            st.subheader("üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç")
            p1, p2 = st.columns(2)
            with p1:
                json_data['progress'] = st.text_area("‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (3 ‡∏™‡πà‡∏ß‡∏ô)", value=json_data.get('progress'), height=250)
            with p2:
                json_data['meds'] = st.text_area("‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏¢‡∏≤ (‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)", value=json_data.get('meds'), height=110)
                json_data['dx'] = st.text_area("‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ (‡∏£‡∏´‡∏±‡∏™ + ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°)", value=json_data.get('dx'), height=110)

            word_file = fill_pmnidat_doc(json_data)
            if word_file:
                st.download_button("üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° 062 (‡∏ü‡∏≠‡∏ô‡∏ï‡πå 13) ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", word_file, f"Refer_{json_data.get('hn','062')}.docx")
        except Exception as e:
            st.error(f"‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {e}")
