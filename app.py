import streamlit as st
import google.generativeai as genai
from docx import Document
from docx.shared import Pt
import io
import re
import json

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ---
API_KEY = "AIzaSyCeLlttCAwHuTLhkqCwAxTUZ-orIMznYT8"
genai.configure(api_key=API_KEY)
model = genai.GenerativeModel('gemini-3-flash-preview')

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå Word (‡∏ü‡∏≠‡∏ô‡∏ï‡πå 13 + ‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) ---
def fill_pmnidat_doc(data):
    try:
        doc = Document("PMNIDAT 062 ‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠.docx")
        mapping = {f"{{{{{k.upper()}}}}}": str(v) for k, v in data.items()}
        
        def apply_style_and_replace(paragraph):
            for key, value in mapping.items():
                if key in paragraph.text:
                    paragraph.text = paragraph.text.replace(key, value)
                    # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏Ç‡∏ô‡∏≤‡∏î 13 ‡∏ï‡∏≤‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏Ø
                    for run in paragraph.runs:
                        run.font.size = Pt(13)

        for p in doc.paragraphs: apply_style_and_replace(p)
        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    for p in cell.paragraphs: apply_style_and_replace(p)
                            
        buffer = io.BytesIO()
        doc.save(buffer)
        return buffer.getvalue()
    except Exception: return None

# --- 3. ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (Linear Workflow & Sidebar Guide) ---
st.set_page_config(page_title="PMNIDAT 062 Smart Portal", layout="wide")

# Sidebar: ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•
with st.sidebar:
    st.image("https://pmnidathis.dms.go.th/static/media/health.1bfd961f.png", width=100)
    st.header("üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    st.info("‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ: ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö @ThanHIS ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢ ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡πä‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ã‡πâ‡∏≤‡∏¢‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏•‡∏á‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î‡∏Ñ‡∏•‡∏¥‡πä‡∏Å‡∏Ç‡∏ß‡∏≤ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å copy ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏Å‡∏î ctrl+c ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö")
    ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á ‡∏Ñ‡∏•‡∏¥‡πä‡∏Å‡∏Ç‡∏ß‡∏≤ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å paste ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Crtl+V ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢")
    st.markdown("""
    **üü¢ STEP 1: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IPD)**
    1. **Admission Note:** ‡∏Å‡∏î‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ	‚Üí Admission note ‚Üí ‡∏Å‡∏î‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    2. **‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢:** ‡∏Å‡∏î "‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢" ‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
    3. **Order/Meds:** ‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π "Order" ‚Üí ‡∏Å‡∏î‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Discharge order + Home medication
    4. **Progress Note:** ‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π "Progress note" ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Progress note ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    
    **üîµ STEP 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô**
    * ‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π "Admission note" ‚Üí ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å ‚Üí ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á **Assessment** -> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 9Q, 8Q, BPRS ‡∏ó‡∏µ‡πà‡∏°‡∏µ
    
    **üü† STEP 3: ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Registration)**
    * ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å ‚Üí ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‚Üí ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‚Üí ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å HN ‚Üí ‡∏Å‡∏î‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ
      ‡∏Å‡∏î‡∏´‡∏ô‡πâ‡∏≤ "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 1"	‚Üí  ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
      ‡∏Å‡∏î‡∏´‡∏ô‡πâ‡∏≤ "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 2"	‚Üí  ‡∏Å‡∏î‡πÅ‡∏™‡∏î‡∏á "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 2.2 (‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)"	‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
      ‡∏Å‡∏î‡∏´‡∏ô‡πâ‡∏≤ "‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠"	‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
      ‡∏Å‡∏î‡∏´‡∏ô‡πâ‡∏≤ "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤"	‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
    """)
    st.divider()
    st.success("üí° AI ‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡πà‡∏∞")

# ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å
st.title("üè• PMNIDAT 062 Smart Portal")
st.subheader("‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (D/C Referral System)")

st.divider()

# ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1: Step 1 (IPD)
st.markdown("### **üü¢ Step 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IPD)**")
s1_cols = st.columns(4)
with s1_cols[0]: s11 = st.text_area("1.1 Admission Note", height=150, placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...")
with s1_cols[1]: s12 = st.text_area("1.2 ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢", height=150, placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ ICD-10 ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...")
with s1_cols[2]: s13 = st.text_area("1.3 Order / Meds", height=150, placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢...")
with s1_cols[3]: s14 = st.text_area("1.4 Progress Note", height=150, placeholder="‡∏ß‡∏≤‡∏á SOAP ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...")

# ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2: Step 2 (Assessment)
st.divider()
st.markdown("### **üîµ Step 2: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (Assessment)**")
s2 = st.text_area("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 9Q, 8Q, BPRS (‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å)", height=150, placeholder="‡∏ß‡∏≤‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...")

# ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 3: Step 3 (Registration)
st.divider()
st.markdown("### **üü† Step 3: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Registration)**")
s3_cols = st.columns(4)
with s3_cols[0]: s31 = st.text_area("3.1 ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 1", height=150, placeholder="‡∏ä‡∏∑‡πà‡∏≠, ‡∏≠‡∏≤‡∏¢‡∏∏, ‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä., ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤")
with s3_cols[1]: s32 = st.text_area("3.2 ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", height=150, placeholder="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 2.2")
with s3_cols[2]: s33 = st.text_area("3.3 ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", height=150, placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ç‡∏≤‡∏ï‡∏¥, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£")
with s3_cols[3]: s34 = st.text_area("3.4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤", height=150, placeholder="‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏£‡∏û.‡∏´‡∏•‡∏±‡∏Å")

# --- 4. ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (Advanced Synthesis Logic) ---
if st.button("üöÄ ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ (Master V3.9)"):
    all_raw = f"{s11} {s12} {s13} {s14} {s2} {s31} {s32} {s33} {s34}"
    with st.spinner('Gemini 3 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏î‡∏Å‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•...'):
        prompt = f"""
        ‡∏à‡∏á‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° 062 ‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
        1. ‡∏¢‡∏≤ (MEDS): ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (\\n) ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ï‡πâ‡∏≠‡∏á UPPERCASE ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
        2. ‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ (DX): ‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ ‡∏£‡∏´‡∏±‡∏™ ICD-10 ‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∏‡∏î) + ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°
        3. ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (PROGRESS): ‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤: 
           (1) ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ (2) ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£ (3) ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
        4. ‡∏Å‡∏é‡∏Ç‡∏¢‡∏∞: Ignore ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Theme Customizer ‡πÅ‡∏•‡∏∞ Navbar ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        5. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢: ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà [‡∏û‡∏¥‡∏°‡∏û‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á] ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á

        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {all_raw}
        ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô: {{"name": "..", "age": "..", "hn": "..", "id": "..", "edu": "..", "career": "..", "religion": "..", "status": "..", "rights": "..", "last_dc": "..", "admit_date": "..", "visit_num": "..", "cc": "..", "contact": "..", "relation": "..", "phone": "..", "near_hosp": "..", "dc_date": "..", "los": "..", "address": "..", "q9": "..", "q8": "..", "meds": "..", "dx": "..", "progress": "..", "post_service": ".."}}
        """
        try:
            response = model.generate_content(prompt)
            json_data = json.loads(re.search(r'\{.*\}', response.text, re.DOTALL).group())
            st.success("‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
            
            # Preview Editor (‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î)
            st.subheader("üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)")
            p1, p2 = st.columns(2)
            with p1:
                json_data['progress'] = st.text_area("‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (3 ‡∏™‡πà‡∏ß‡∏ô)", value=json_data.get('progress'), height=250)
            with p2:
                json_data['meds'] = st.text_area("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)", value=json_data.get('meds'), height=110)
                json_data['dx'] = st.text_area("‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ (‡∏£‡∏´‡∏±‡∏™ + ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°)", value=json_data.get('dx'), height=110)
            
            word_file = fill_pmnidat_doc(json_data)
            if word_file:
                st.download_button("üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° 062 (‡∏ü‡∏≠‡∏ô‡∏ï‡πå 13)", word_file, f"Refer_{json_data['hn']}.docx")
        except Exception as e:
            st.error(f"‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {e}")

